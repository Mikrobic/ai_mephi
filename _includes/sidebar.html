<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>{{ site.description }}</p>
  </div>

  <nav class="sidebar-nav">
    <!-- Порядок страниц -->
    <a class="sidebar-nav-item" href="{{ site.baseurl }}/for_me/">Обо мне</a>
    <a class="sidebar-nav-item" href="{{ site.baseurl }}/stack/">Стек</a>
    <a class="sidebar-nav-item" href="{{ site.baseurl }}/career/">Карьерный трек</a>


    <!-- Вложенное меню project -->
    <div class="sidebar-nav-group{% if page.url contains '/project/' %} active{% endif %}">
      <a href="javascript:void(0)" class="sidebar-nav-item sidebar-nav-toggle{% if page.url contains '/project/' %} active{% endif %}">
        Проекты
        <svg class="toggle-icon" viewBox="0 0 24 24">
          <path d="M7 10l5 5 5-5z"/>
        </svg>
      </a>
      <div class="sidebar-submenu">
        <a href="{{ site.baseurl }}/project/subpage/" 
           class="sidebar-nav-item submenu-item{% if page.url == '/project/subpage/' %} active{% endif %}">
          Дашборд по учёту ёмкости ресурсов компании
        </a>
      </div>
    </div>

  <div class="sidebar-item">
    <p>
      &copy; {{ site.time | date: '%Y' }}. Тимакин Сергей.
    </p>
  </div>
</div>

<style>
  /* Стили для групп меню */
  .sidebar-nav-group {
    position: relative;
  }

  .sidebar-nav-toggle {
    position: relative;
    padding-right: 2rem;
  }

  .toggle-icon {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 1em;
    height: 1em;
    fill: currentColor;
    transition: transform 0.2s;
  }

  .sidebar-nav-group.active .toggle-icon {
    transform: translateY(-50%) rotate(180deg);
  }

  .sidebar-submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    margin-left: 15px;
  }

  .sidebar-nav-group.active .sidebar-submenu {
    max-height: 500px;
  }

  /* Стили для подпунктов */
  .submenu-item {
    position: relative;
    padding-left: 15px !important;
  }

  .submenu-item::before {
    content: "*";
    position: absolute;
    left: 0;
    color: #268bd2;
  }

  .sidebar-nav-toggle, 
  .sidebar-nav-toggle:hover {
    color: inherit;
    text-decoration: none;
  }
</style>

<script>
(function(document) {
  // Сохраняем состояние сайдбара
  const sidebarCheckbox = document.getElementById('sidebar-checkbox');
  
  // Восстановление состояния сайдбара
  if (localStorage.getItem('sidebarState') === 'open') {
    sidebarCheckbox.checked = true;
  }

  // Обработчик изменений состояния сайдбара
  sidebarCheckbox.addEventListener('change', function() {
    localStorage.setItem('sidebarState', this.checked ? 'open' : 'closed');
  });


  // Оригинальный код для закрытия сайдбара
  var toggle = document.querySelector('.sidebar-toggle');
  var sidebar = document.querySelector('#sidebar');
  const sidebarToggle = document.querySelector('.sidebar-toggle');



  // Закрытие сайдбара при клике на него
  sidebar.addEventListener('click', function(e) {
  // Проверяем, что клик был именно по сайдбару (не по его содержимому)
    if (e.target === sidebar && sidebarCheckbox.checked) {
      sidebarCheckbox.checked = false;
      localStorage.setItem('sidebarState', 'closed');
      e.stopPropagation();
    }
  });


  sidebarToggle.addEventListener('click', function(e) {
    e.preventDefault();
    sidebarCheckbox.checked = !sidebarCheckbox.checked; // Переключаем состояние
    localStorage.setItem('sidebarState', sidebarCheckbox.checked ? 'open' : 'closed');
  });


  document.addEventListener('click', function(e) {
    var target = e.target;
    if (!sidebarCheckbox.checked || sidebar.contains(target) || target === sidebarCheckbox) return;
    sidebarCheckbox.checked = false;
    localStorage.setItem('sidebarState', 'closed');
  });

  // Обработчики для раскрывающихся меню с сохранением состояния
  document.addEventListener('DOMContentLoaded', function() {
    // Функция сохранения состояния меню
    const saveMenuState = (group) => {
      const menuId = 'home_menu';
      localStorage.setItem(menuId, group.classList.contains('active') ? 'open' : 'closed');
    };

    // Функция восстановления состояния меню
    const restoreMenuState = (group) => {
      const menuId = 'home_menu';
      if (localStorage.getItem(menuId) === 'open') {
        group.classList.add('active');
      }
    };

    const toggleButtons = document.querySelectorAll('.sidebar-nav-toggle');
    
    toggleButtons.forEach(button => {
      const group = button.closest('.sidebar-nav-group');
      restoreMenuState(group);
      
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        group.classList.toggle('active');
        saveMenuState(group);
      });
    });

    // Автоматически раскрываем меню для активной страницы
    const activeSubItem = document.querySelector('.sidebar-submenu .active');
    if (activeSubItem) {
      const parentGroup = activeSubItem.closest('.sidebar-nav-group');
      parentGroup.classList.add('active');
      saveMenuState(parentGroup);
    }
  });
})(document);
</script>
